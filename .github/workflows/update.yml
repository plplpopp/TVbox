name: TVç›´æ’­æºè‡ªåŠ¨æ›´æ–°

on:
  # å®šæ—¶è§¦å‘ï¼šæ¯å¤©5ç‚¹ã€12ç‚¹ã€17ç‚¹ï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´13ç‚¹ã€20ç‚¹ã€æ¬¡æ—¥1ç‚¹ï¼‰
  schedule:
    - cron: '0 5,12,17 * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_speed_test:
        description: 'è·³è¿‡æµ‹é€Ÿï¼ˆåŠ å¿«æ›´æ–°é€Ÿåº¦ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# è®¾ç½®å·¥ä½œæµæƒé™
permissions:
  contents: write

jobs:
  update-sources:
    name: æ›´æ–°ç›´æ’­æº
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: åˆ›å»ºé…ç½®æ–‡ä»¶ç›®å½•
      run: |
        mkdir -p config output logs
        
    - name: å‡†å¤‡é…ç½®æ–‡ä»¶
      run: |
        # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
        if [ ! -f config/config.ini ]; then
          echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
          cat > config/config.ini << 'EOF'
[Settings]
; åŠŸèƒ½å¼€å…³é…ç½®
open_driver = False
open_epg = False
open_empty_category = False
open_filter_resolution = True
open_filter_speed = True
open_hotel = False
open_hotel_foodie = True
open_hotel_fofa = False
open_local = True
open_m3u_result = True
open_multicast = False
open_multicast_foodie = True
open_multicast_fofa = False
open_request = False
open_rtmp = True
open_service = True
open_speed_test = ${{ inputs.skip_speed_test == 'true' && 'False' || 'True' }}
open_subscribe = True
open_supply = True
open_update = True
open_update_time = True
open_url_info = False
open_use_cache = ${{ inputs.force_update == 'true' && 'False' || 'True' }}
open_history = True
open_headers = False
speed_test_filter_host = False
ipv6_support = False

; ç½‘ç»œæœåŠ¡é…ç½®
app_host = http://localhost
app_port = 8000
cdn_url = 

; æ–‡ä»¶è·¯å¾„é…ç½®
final_file = output/result.txt
local_file = config/local.txt
source_file = config/demo.txt

; æ•°é‡é™åˆ¶é…ç½®
hotel_num = 10
hotel_page_num = 1
multicast_num = 10
multicast_page_num = 1
local_num = 15
subscribe_num = 15
urls_limit = 8

; åœ°åŒºè®¾ç½®é…ç½®
hotel_region_list = å…¨éƒ¨
multicast_region_list = å…¨éƒ¨

; ç½‘ç»œä¼˜åŒ–é…ç½®
isp = 
ipv4_num = 
ipv6_num = 
ipv_type = å…¨éƒ¨
ipv_type_prefer = auto
location = 

; è´¨é‡è®¾ç½®é…ç½®
min_resolution = 1920x1080
max_resolution = 1920x1080
min_speed = 0.5

; æ—¶é—´è®¾ç½®é…ç½®
recent_days = 30
request_timeout = 15
speed_test_limit = 8
speed_test_timeout = 10
time_zone = Asia/Shanghai
update_interval = 12
update_time_position = top
EOF
        fi
        
        # åˆ›å»ºæœ¬åœ°æºæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f config/local.txt ]; then
          echo "åˆ›å»ºæœ¬åœ°æºæ–‡ä»¶..."
          cat > config/local.txt << 'EOF'
# æœ¬åœ°æºé¢‘é“åˆ—è¡¨
# æ ¼å¼: é¢‘é“åç§°,é¢‘é“URL
# è‡ªåŠ¨æ›´æ–°æ—¶ä¼šä¿ç•™æ­¤æ–‡ä»¶ä¸­çš„æº
EOF
        fi
        
        # åˆ›å»ºè®¢é˜…æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f config/subscribe.txt ]; then
          echo "åˆ›å»ºè®¢é˜…æ–‡ä»¶..."
          cat > config/subscribe.txt << 'EOF'
# è®¢é˜…æºURLåˆ—è¡¨
# æ¯è¡Œä¸€ä¸ªè®¢é˜…URLï¼Œæ”¯æŒM3Uæ ¼å¼å’Œæ–‡æœ¬æ ¼å¼

# ç¤ºä¾‹è®¢é˜…æºï¼ˆå®é™…ä½¿ç”¨æ—¶è¯·æ›¿æ¢ä¸ºçœŸå®çš„è®¢é˜…æºï¼‰
# https://example.com/playlist.m3u8
EOF
        fi
        
        # åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f config/demo.txt ]; then
          echo "åˆ›å»ºæ¨¡æ¿æ–‡ä»¶..."
          cat > config/demo.txt << 'EOF'
# æ¨¡æ¿æºæ–‡ä»¶
# ç”¨äºå®šä¹‰é¢‘é“ç»“æ„å’Œé»˜è®¤æº

CCTV-1,
CCTV-2,
CCTV-5,
æ¹–å—å«è§†,
æµ™æ±Ÿå«è§†,
æ±Ÿè‹å«è§†,
åŒ—äº¬å«è§†,
ä¸œæ–¹å«è§†,
EOF
        fi
        
    - name: è¿è¡Œç›´æ’­æºæ›´æ–°
      id: update
      run: |
        echo "å¼€å§‹æ›´æ–°ç›´æ’­æº..."
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        
        # è¿è¡Œæ›´æ–°ç¨‹åº
        python main.py
        
        # æ£€æŸ¥ç»“æœæ–‡ä»¶
        if [ -f output/result.txt ]; then
          SOURCE_COUNT=$(grep -c "," output/result.txt || true)
          echo "æ›´æ–°å®Œæˆï¼Œæ‰¾åˆ° $SOURCE_COUNT ä¸ªæœ‰æ•ˆæº"
          echo "source_count=$SOURCE_COUNT" >> $GITHUB_OUTPUT
        else
          echo "é”™è¯¯ï¼šç»“æœæ–‡ä»¶æœªç”Ÿæˆ"
          echo "source_count=0" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: æ˜¾ç¤ºæ›´æ–°ç»“æœ
      run: |
        echo "=== æ›´æ–°ç»“æœç»Ÿè®¡ ==="
        if [ -f output/result.txt ]; then
          echo "ç»“æœæ–‡ä»¶å¤§å°: $(wc -c < output/result.txt) å­—èŠ‚"
          echo "æœ‰æ•ˆæºæ•°é‡: ${{ steps.update.outputs.source_count }}"
          echo "å‰10ä¸ªé¢‘é“:"
          head -20 output/result.txt | grep -v "^#"
        else
          echo "é”™è¯¯ï¼šç»“æœæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: æäº¤æ›´æ–°ç»“æœ
      if: steps.update.outputs.source_count > 0
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ æ›´æ”¹çš„æ–‡ä»¶
        git add output/result.txt
        git add logs/update.log || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
        else
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - ${{ steps.update.outputs.source_count }}ä¸ªæœ‰æ•ˆæº [$(date +'%Y-%m-%d %H:%M')]"
          
          # æ¨é€åˆ°ä»“åº“
          git push
          echo "æ›´æ–°ç»“æœå·²æäº¤åˆ°ä»“åº“"
        fi
        
    - name: ä¸Šä¼ ç»“æœæ–‡ä»¶ä½œä¸ºåˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: tv-sources-result
        path: |
          output/result.txt
          logs/update.log
        retention-days: 7
        
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: success() && steps.update.outputs.source_count > 0
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |-
          ğŸ‰ TVç›´æ’­æºè‡ªåŠ¨æ›´æ–°æˆåŠŸï¼
          - æœ‰æ•ˆæºæ•°é‡: ${{ steps.update.outputs.source_count }}
          - æ›´æ–°æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M UTC")
        channel: '#notifications'  # å¯é€‰ï¼šæŒ‡å®šSlacké¢‘é“
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true  # Slacké€šçŸ¥å¤±è´¥ä¸å½±å“å·¥ä½œæµ
        
    - name: å‘é€å¤±è´¥é€šçŸ¥
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |-
          âŒ TVç›´æ’­æºè‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼
          - è¯·æ£€æŸ¥å·¥ä½œæµè¿è¡Œæ—¥å¿—
          - å¤±è´¥æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M UTC")
        channel: '#notifications'  # å¯é€‰ï¼šæŒ‡å®šSlacké¢‘é“
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      continue-on-error: true
