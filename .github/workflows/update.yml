name: TVç›´æ’­æºè‡ªåŠ¨æ›´æ–°

on:
  schedule:
    - cron: '0 5,12,17 * * *'
  
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      skip_speed_test:
        description: 'è·³è¿‡æµ‹é€Ÿï¼ˆåŠ å¿«æ›´æ–°é€Ÿåº¦ï¼‰'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  update-sources:
    name: æ›´æ–°ç›´æ’­æº
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
        fi
        
    - name: åˆ›å»ºç›®å½•ç»“æ„
      run: |
        mkdir -p config output logs
        echo "ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"
        
    - name: å‡†å¤‡é…ç½®æ–‡ä»¶
      run: |
        set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        if [ ! -f config/config.ini ]; then
          echo "åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶..."
          cat > config/config.ini << 'EOF'
[Settings]
; åŸºæœ¬åŠŸèƒ½å¼€å…³
open_epg = False
open_empty_category = False
open_filter_resolution = True
open_filter_speed = True
open_hotel = False
open_hotel_foodie = True
open_hotel_fofa = False
open_local = True
open_m3u_result = True
open_multicast = False
open_multicast_foodie = True
open_multicast_fofa = False
open_request = False
open_rtmp = True
open_service = True
open_speed_test = ${{ inputs.skip_speed_test == 'true' && 'False' || 'True' }}
open_subscribe = True
open_supply = True
open_update = True
open_use_cache = ${{ inputs.force_update == 'true' && 'False' || 'True' }}

; æ–‡ä»¶è·¯å¾„é…ç½®
final_file = output/result.txt
local_file = config/local.txt
source_file = config/demo.txt

; è´¨é‡è®¾ç½®
min_resolution = 1920x1080
max_resolution = 1920x1080
min_speed = 0.5

; ç½‘ç»œè®¾ç½®
request_timeout = 15
speed_test_timeout = 10
time_zone = Asia/Shanghai
EOF
          echo "é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        else
          echo "é…ç½®æ–‡ä»¶å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
        fi
        
        # åˆ›å»ºå¿…è¦çš„ç¤ºä¾‹æ–‡ä»¶
        for file in local.txt subscribe.txt demo.txt; do
          if [ ! -f "config/${file}" ]; then
            echo "åˆ›å»º config/${file}"
            touch "config/${file}"
          fi
        done
        
    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== é…ç½®æ–‡ä»¶éªŒè¯ ==="
        if [ -f config/config.ini ]; then
          echo "é…ç½®æ–‡ä»¶å†…å®¹:"
          cat config/config.ini
          echo "é…ç½®æ–‡ä»¶è¡Œæ•°: $(wc -l < config/config.ini)"
        else
          echo "é”™è¯¯ï¼šé…ç½®æ–‡ä»¶æœªåˆ›å»º"
          exit 1
        fi
        
    - name: è¿è¡Œç›´æ’­æºæ›´æ–°
      id: update
      run: |
        echo "å¼€å§‹æ›´æ–°ç›´æ’­æº..."
        echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        # æ£€æŸ¥ä¸»ç¨‹åºæ˜¯å¦å­˜åœ¨
        if [ ! -f main.py ]; then
          echo "é”™è¯¯ï¼šmain.py ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•æ–‡ä»¶:"
          ls -la
          exit 1
        fi
        
        # è¿è¡Œæ›´æ–°ç¨‹åº
        python main.py || echo "ç¨‹åºæ‰§è¡Œå®Œæˆ"
        
        # ç»Ÿè®¡ç»“æœ
        if [ -f output/result.txt ]; then
          SOURCE_COUNT=$(grep -c "^[^#]" output/result.txt 2>/dev/null || echo "0")
          echo "æœ‰æ•ˆæºæ•°é‡: $SOURCE_COUNT"
          echo "source_count=$SOURCE_COUNT" >> $GITHUB_OUTPUT
        else
          echo "ç»“æœæ–‡ä»¶æœªç”Ÿæˆï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
          touch output/result.txt
          echo "source_count=0" >> $GITHUB_OUTPUT
        fi
        
    - name: æ˜¾ç¤ºæ›´æ–°ç»“æœ
      run: |
        echo "=== æ›´æ–°ç»“æœ ==="
        if [ -f output/result.txt ]; then
          FILE_SIZE=$(wc -c < output/result.txt)
          LINE_COUNT=$(wc -l < output/result.txt)
          echo "æ–‡ä»¶å¤§å°: ${FILE_SIZE} å­—èŠ‚"
          echo "æ€»è¡Œæ•°: ${LINE_COUNT} è¡Œ"
          echo "æœ‰æ•ˆæºæ•°: ${{ steps.update.outputs.source_count }}"
          
          if [ $FILE_SIZE -gt 0 ]; then
            echo "å‰5ä¸ªé¢‘é“:"
            head -10 output/result.txt | grep -v "^#" | head -5 || echo "æ— æœ‰æ•ˆé¢‘é“"
          else
            echo "ç»“æœæ–‡ä»¶ä¸ºç©º"
          fi
        else
          echo "é”™è¯¯ï¼šç»“æœæ–‡ä»¶ä¸å­˜åœ¨"
        fi
        
    - name: æäº¤æ›´æ”¹
      if: steps.update.outputs.source_count > 0 || always()
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ·»åŠ å¯èƒ½æ›´æ”¹çš„æ–‡ä»¶
        git add output/ || true
        git add logs/ || true
        git add config/ || true
        
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        else
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - ${{ steps.update.outputs.source_count }}ä¸ªæœ‰æ•ˆæº"
          git push
          echo "æ›´æ”¹å·²æäº¤"
        fi
        
    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: tv-sources-${{ github.run_id }}
        path: |
          output/
          logs/
        retention-days: 3
        
    - name: å·¥ä½œæµçŠ¶æ€æ€»ç»“
      if: always()
      run: |
        echo "=== å·¥ä½œæµæ‰§è¡Œç»“æœ ==="
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "å¼€å§‹æ—¶é—´: ${{ github.event.workflow_run.created_at }}"
        echo "ç»“æœæ–‡ä»¶: output/result.txt"
        echo "æœ‰æ•ˆæºæ•°: ${{ steps.update.outputs.source_count }}"
